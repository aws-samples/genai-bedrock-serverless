

## Build scalable containerized RAG based generative AI applications in AWS using Amazon EKS and Amazon Bedrock

1. Build automated and scalable containerized GenAI applications in AWS on using EKS and Bedrock to provide intelligent RAG workflows
2. Automate ingestion of data from multiple data sources using Bedrock Knowledgebases
3. Provide a highly available API interface that allows for pluggable front ends and event driven invocation of LLMs


### Prerequisites

1. Ensure you have [model access in Amazon Bedrock](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access.html) for both the Anthropic Claude v3 and Titan Text Embedding models available on Amazon Bedrock.
2. Install [AWS CLI](https://aws.amazon.com/cli)
3. Install [Docker](https://docs.docker.com/engine/install/)
4. [Install Terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli)

### Deploy the solution
Cloning the repository and using the Terraform template will provision all the components of this solution:

1. Clone the repository for this solution:
```
sudo yum install -y unzip
git clone https://github.com/aws-samples/genai-bedrock-fsxontap.git
cd eksbedrock/terraform
```
2. From the _terraform_ folder, deploy the entire solution using terraform:
```
terraform init
terraform apply -auto-approve
```

### Configure EKS

1. Configure a secret for the ECR registry:
```
aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin <your account id>.dkr.ecr.<your account region>.amazonaws.com

docker pull <your account id>.dkr.ecr.us-east-2.amazonaws.com/bedrockragrepo:latest

aws eks update-kubeconfig --region <your region> --name eksbedrock

kubectl create secret docker-registry ecr-secret \
  --docker-server=<your account id>.dkr.ecr.<your account region>.amazonaws.com \
  --docker-username=AWS \
  --docker-password=$(aws ecr get-login-password --region <your account region>)

```
2. Navigate to the _kubernetes/ingress_ folder. 
    1. Ensure that the _AWS_Region_ variable in the bedrockragconfigmap.yaml file points to your AWS region.
    2. Replace the image URI in line 20 of the bedrockragdeployment.yaml file with the image URI of your bedrockrag image from your ECR repository.

3. Provision the Kubernetes deployment, service and ingress:
```
cd ..
kubectl apply -f ingress/
```

### Configure Bedrock

1. Create an Amazon Bedrock knowledge base. Follow the steps [here](https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base-create.html) to create a knowledge base. Accept all the defaults including using the **Quick create a new vector store** option in Step 7 that creates an Amazon OpenSearch Serverless vector search collection as your knowledge base. 
    1. In Step 5c where you need to provide the S3 URI of the object containing the files for the data source for the knowledge base

### Solution Overview

Hereâ€™s a high-level architecture diagram that illustrates the various components of our solution working together as described in the flow above:

![Solution Architecture](/eksbedrock/images/solution-arch.png)


### Test and Validate

The Amazon Bedrock console provides a UI to test your agent. [Follow the steps here to test and prepare your agent](https://docs.aws.amazon.com/bedrock/latest/userguide/agents-test.html) so that is ready to deploy. [Follow the steps here to deploy your agent](https://docs.aws.amazon.com/bedrock/latest/userguide/agents-deploy.html) by creating an alias for the agent and an agent version that is associated to that alias. You are now ready to test your agent. 

Provide a sample prompt in the Bedrock agent UI where as a support analyst you are looking to resolve an error based on an HTTP error code and timestamp of the error provided by the application. You can look for sample error codes and associated timestamps in the sample application log file that we have provided in our solution. Here's a sample prompt and the agent response providing detailed error resolution and citation of sources where it obtained information to resolve the error:

![Sample prompt](/cloudops/images/sample-prompt.png) 

By selecting **Show trace** for the response, a dialog box shows the reasoning technique used by the agent and the final response generated by the FM.

![Agent Trace 1](/cloudops/images/agent-trace1.png)

![Agent Trace 2](/cloudops/images/agent-trace2.png)

![Agent Trace 3](/cloudops/images/agent-trace3.png)


### Clean up

To avoid recurring charges, and to clean up your account after trying the solution outlined in this post, perform the following steps:

1. From the _terraform_ folder, delete the Terraform template for the solution:
```
terraform apply --destroy
```
2. Delete the Amazon Bedrock knowledge base. From the Amazon Bedrock console, select the knowledge base you created in this solution, select Delete and follow the steps to delete the knowledge base
